{% extends 'base.html' %}
{% load humanize %}
{% load l10n %}

{% block title %}
    {% if arsiv_modu %}üóÑÔ∏è Talep Ar≈üivi{% else %}Teklif Y√∂netimi{% endif %}
{% endblock %}

{% block extra_css %}
<style>
    .request-card { 
        background: white; border: none; border-radius: 10px; 
        box-shadow: 0 4px 10px rgba(0,0,0,0.05); margin-bottom: 25px; 
        overflow: hidden; border-left: 6px solid #bdc3c7;
    }
    .request-card.acil { border-left-color: #f1c40f; }
    .request-card.cok_acil { border-left-color: #dc3545; }
    .request-card.islemde { border-left-color: #3498db; }
    .request-card.onaylandi { border-left-color: #198754; background-color: #f8fff9; }
    .request-card.tamamlandi { border-left-color: #6c757d; background-color: #fcfcfc; opacity: 0.9; }

    .req-header { padding: 15px 20px; border-bottom: 1px solid #f0f0f0; display: flex; justify-content: space-between; align-items: center; background: #fff; }
    .req-body { padding: 20px; background: #fdfdfd; }
    .req-footer { background: #f1f2f6; padding: 10px 20px; font-size: 0.85rem; color: #7f8c8d; display: flex; gap: 20px; align-items: center; }

    .teklif-wrapper { 
        display: flex; 
        gap: 20px; 
        overflow-x: auto; 
        padding-bottom: 15px; 
        padding-top: 25px;
        padding-left: 5px;
    }
    
    .teklif-kutusu { 
        min-width: 320px;
        background-color: white; border: 1px solid #dee2e6; 
        border-radius: 8px; padding: 15px; transition: all 0.3s; position: relative;
        box-shadow: 0 2px 5px rgba(0,0,0,0.02);
    }
    .teklif-kutusu:hover { box-shadow: 0 10px 20px rgba(0,0,0,0.1); transform: translateY(-3px); border-color: #bbb; }
    
    .teklif-kutusu.onayli { border: 2px solid #198754; background-color: #f0fff4; }
    .teklif-kutusu.reddedildi { border: 1px solid #dc3545; background-color: #fff5f5; opacity: 0.6; }

    .action-btn { width: 32px; height: 32px; line-height: 30px; text-align: center; border-radius: 50%; font-size: 13px; margin-left: 4px; cursor: pointer; transition: all 0.2s; }
    .action-btn:hover { transform: scale(1.15); }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid" style="max-width: 1400px;">
    
    <div class="d-flex justify-content-between align-items-center my-4 sticky-top bg-white p-3 shadow-sm rounded" style="z-index: 1000;">
        <div>
            {% if arsiv_modu %}
                <h2 class="h4 fw-bold text-secondary mb-0"><i class="fas fa-archive me-2"></i> TAMAMLANAN ƒ∞≈ûLER AR≈ûƒ∞Vƒ∞</h2>
                <p class="text-muted mb-0 small">Ge√ßmi≈üte tamamlanƒ±p kapatƒ±lan talepler burada listelenir.</p>
            {% else %}
                <h2 class="h4 fw-bold text-dark mb-0"><i class="fas fa-tasks me-2"></i> ƒ∞CMAL ve TEKLƒ∞F Y√ñNETƒ∞Mƒ∞</h2>
                <p class="text-muted mb-0 small">Saha taleplerine g√∂re toplanan teklifleri y√∂netin.</p>
            {% endif %}
        </div>
        <div>
            {% if arsiv_modu %}
                <a href="{% url 'icmal_raporu' %}" class="btn btn-outline-primary fw-bold">
                    <i class="fas fa-list-ul me-2"></i> Aktif Listeye D√∂n
                </a>
            {% else %}
                <a href="{% url 'arsiv_raporu' %}" class="btn btn-outline-secondary me-2">
                    <i class="fas fa-history me-2"></i> Ar≈üiv (Ge√ßmi≈ü)
                </a>
                <a href="{% url 'dashboard' %}" class="btn btn-secondary">‚Üê Ana Men√º</a>
            {% endif %}
        </div>
    </div>

    {% for talep in aktif_talepler %}
    <div class="request-card {{ talep.oncelik }} {{ talep.durum }}">
        
        <div class="req-header">
            <div class="d-flex align-items-center">
                
                <a href="{% url 'talep_sil' talep.id %}" class="text-danger me-3 opacity-50 hover-opacity-100" title="Talebi Sil" onclick="return confirm('Silmek istediƒüinize emin misiniz?');">
                    <i class="fas fa-trash-alt"></i>
                </a>

                <span class="badge bg-secondary me-2">#{{ talep.id }}</span>
                
                <span class="fw-bold fs-5 text-dark me-2">
                    {% if talep.malzeme %}
                        <i class="fas fa-box text-primary me-1"></i> {{ talep.malzeme.isim }}
                    {% elif talep.is_kalemi %}
                        <i class="fas fa-tools text-danger me-1"></i> {{ talep.is_kalemi.isim }}
                    {% endif %}
                </span>

                <span class="fs-5 text-muted">
                    x {{ talep.miktar }} 
                    {% if talep.malzeme %}{{ talep.malzeme.get_birim_display }}
                    {% else %}{{ talep.is_kalemi.get_birim_display }}{% endif %}
                </span>
                
                {% if not arsiv_modu %}
                    {% if talep.oncelik == 'cok_acil' %}<span class="badge bg-danger ms-2"><i class="fas fa-fire me-1"></i> √áOK ACƒ∞L</span>
                    {% elif talep.oncelik == 'acil' %}<span class="badge bg-warning text-dark ms-2"><i class="fas fa-bolt me-1"></i> ACƒ∞L</span>{% endif %}
                {% endif %}
                
                {% if talep.durum == 'bekliyor' %}<span class="badge bg-light text-dark border ms-2">‚è≥ Onay Bekliyor</span>
                {% elif talep.durum == 'islemde' %}<span class="badge bg-info text-dark ms-2">üîç Teklif Toplanƒ±yor</span>
                {% elif talep.durum == 'tamamlandi' %}<span class="badge bg-secondary ms-2"><i class="fas fa-check-double me-1"></i> TAMAMLANDI</span>{% endif %}
            </div>

            <div>
                {% if talep.durum == 'onaylandi' %}
                    <div class="d-flex align-items-center gap-2">
                        <span class="badge bg-success p-2"><i class="fas fa-check-circle me-1"></i> Sƒ∞PARƒ∞≈û ONAYLANDI</span>
                        <a href="{% url 'talep_tamamla' talep.id %}" class="btn btn-outline-secondary btn-sm" title="Listeden Kaldƒ±r / Ar≈üivle">
                            <i class="fas fa-archive me-1"></i> Ar≈üivle
                        </a>
                    </div>
                
                {% elif talep.durum == 'bekliyor' %}
                    <a href="{% url 'talep_onayla' talep.id %}" class="btn btn-warning btn-sm fw-bold shadow-sm text-dark"><i class="fas fa-play-circle me-1"></i> Onayla & Ba≈ülat</a>
                    
                {% elif talep.durum == 'islemde' %}
                    <a href="{% url 'teklif_ekle' %}?talep_id={{ talep.id }}" class="btn btn-primary btn-sm fw-bold shadow-sm"><i class="fas fa-plus-circle me-1"></i> Teklif Gir</a>
                
                {% elif talep.durum == 'tamamlandi' %}
                    <a href="{% url 'talep_arsivden_cikar' talep.id %}" class="btn btn-outline-dark btn-sm shadow-sm">
                        <i class="fas fa-undo-alt me-1"></i> Aktif Listeye Geri Al
                    </a>
                {% endif %}
            </div>
        </div>

        <div class="req-body">
            {% if talep.teklifler.all %}
                <div class="teklif-wrapper">
                    {% for teklif in talep.teklifler.all %}
                        
                        {% if teklif.id == talep.en_uygun_teklif_id and talep.teklifler.count > 1 %}
                            <div class="teklif-kutusu" style="border: 2px solid #28a745; background-color: #f0fff4; position: relative;">
                                <div class="position-absolute top-0 start-50 translate-middle badge rounded-pill bg-success shadow-sm border border-light" style="z-index: 10;">
                                    <i class="fas fa-star text-warning"></i> EN UYGUN
                                </div>
                        {% else %}
                            <div class="teklif-kutusu {% if teklif.durum == 'onaylandi' %}onayli{% elif teklif.durum == 'reddedildi' %}reddedildi{% endif %}">
                        {% endif %}
                        
                            <div class="d-flex justify-content-between mb-2 border-bottom pb-2 mt-2">
                                <span class="badge {% if teklif.durum == 'onaylandi' %}bg-success{% elif teklif.durum == 'reddedildi' %}bg-danger{% else %}bg-warning text-dark{% endif %}">
                                    {{ teklif.get_durum_display }}
                                </span>
                                
                                {% if not arsiv_modu %}
                                <div class="d-flex">
                                    <a href="/admin/core/teklif/{{ teklif.id }}/change/" target="_blank" class="btn btn-outline-primary action-btn" title="D√ºzenle"><i class="fas fa-pencil-alt"></i></a>
                                    
                                    {% if teklif.durum != 'onaylandi' %}
                                        <a href="{% url 'teklif_durum_guncelle' teklif.id 'onaylandi' %}" class="btn btn-outline-success action-btn" title="Onayla"><i class="fas fa-check"></i></a>
                                    {% endif %}
                                    
                                    {% if teklif.durum != 'beklemede' %}
                                        <a href="{% url 'teklif_durum_guncelle' teklif.id 'beklemede' %}" class="btn btn-outline-warning action-btn" title="Beklemeye Al"><i class="fas fa-hourglass-half"></i></a>
                                    {% endif %}
                                    
                                    {% if teklif.durum != 'reddedildi' %}
                                        <a href="{% url 'teklif_durum_guncelle' teklif.id 'reddedildi' %}" class="btn btn-outline-danger action-btn" title="Reddet"><i class="fas fa-times"></i></a>
                                    {% endif %}
                                </div>
                                {% endif %}
                            </div>

                            <div class="fw-bold text-primary text-truncate mb-1" title="{{ teklif.tedarikci.firma_unvani }}">{{ teklif.tedarikci.firma_unvani }}</div>
                            
                            <div class="fs-4 fw-bold {% if teklif.id == talep.en_uygun_teklif_id and talep.teklifler.count > 1 %}text-success{% else %}text-dark{% endif %} mb-1">
                                {{ teklif.toplam_fiyat_tl|floatformat:2|intcomma }} ‚Ç∫
                            </div>
                            
                            <div class="small text-muted">Birim: {{ teklif.birim_fiyat|floatformat:2 }} {{ teklif.para_birimi }} {% if teklif.kdv_orani > 0 %}(+KDV){% endif %}</div>
                            
                            {% if teklif.teklif_dosyasi %}
                                <a href="{{ teklif.teklif_dosyasi.url }}" target="_blank" class="btn btn-sm btn-light w-100 mt-3 text-danger border"><i class="fas fa-file-pdf me-1"></i> Dosya</a>
                            {% endif %}
                        </div>
                    {% endfor %}
                </div>
            {% else %}
                <div class="text-center py-4 text-muted border border-dashed rounded bg-light">
                    <i class="fas fa-inbox fa-2x mb-2 text-secondary"></i><br>Teklif bulunamadƒ±.
                </div>
            {% endif %}
        </div>

        <div class="req-footer">
            <span><i class="fas fa-user me-1"></i> Talep: <strong>{% if talep.talep_eden %}{{ talep.talep_eden.get_full_name|default:talep.talep_eden.username }}{% else %}Bilinmiyor{% endif %}</strong></span>
            <span><i class="fas fa-map-marker-alt me-1"></i> {{ talep.proje_yeri|default:"-" }}</span>
            <span><i class="fas fa-calendar-alt me-1"></i> {{ talep.tarih|date:"d.m.Y" }}</span>
            {% if talep.aciklama %}<span class="text-truncate" style="max-width: 300px;" title="{{ talep.aciklama }}"><i class="fas fa-comment-alt me-1"></i> {{ talep.aciklama }}</span>{% endif %}
        </div>
    </div>
    {% empty %}
    <div class="text-center py-5">
        <h3 class="text-muted fw-bold">Liste Bo≈ü</h3>
        <p class="text-secondary">{% if arsiv_modu %}Hen√ºz ar≈üivlenmi≈ü (tamamlanmƒ±≈ü) bir i≈ü yok.{% else %}Aktif bir talep bulunmuyor.{% endif %}</p>
    </div>
    {% endfor %}

</div>
{% endblock %}