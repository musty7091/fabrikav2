{% extends 'base.html' %}
{% block title %}Fatura Girişi{% endblock %}

{% block content %}
<div class="container py-5">
  <div class="row justify-content-center">
    <div class="col-lg-10">
      <div class="card shadow border-0">
        <div class="card-header bg-dark text-white py-3 d-flex justify-content-between align-items-center">
          <h5 class="mb-0 fw-bold">
            <i class="fas fa-file-invoice me-2"></i> ALIŞ FATURASI GİRİŞİ (ÇOK KALEM)
          </h5>
          <span class="badge bg-warning text-dark">
            {% if siparis %}
              Sipariş #{{ siparis.id }} — {{ siparis.teklif.tedarikci.firma_unvani }}
            {% else %}
              Serbest Fatura
            {% endif %}
          </span>
        </div>

        <div class="card-body p-4">

          <div class="alert alert-secondary d-flex">
            <div class="me-4 text-center">
              <i class="fas fa-truck fa-2x text-muted"></i>
            </div>
            <div class="w-100">
              <h6 class="fw-bold mb-1">{{ siparis.teklif.tedarikci.firma_unvani }}</h6>
              <small class="d-block">
                Bu ekran aynı fatura içinde <b>birden fazla ürün</b> girebilir.
                <br>
                <span class="text-danger">
                  (Kural) Tek fatura = tek tedarikçi ✅
                </span>
              </small>
            </div>
          </div>

          <form method="post" enctype="multipart/form-data">
            {% csrf_token %}

            {% if form.non_field_errors %}
              <div class="alert alert-danger">{{ form.non_field_errors }}</div>
            {% endif %}
            
            {% if form.errors %}
              <div class="alert alert-danger">
                <b>Form Hataları</b>
                <pre style="white-space: pre-wrap;">{{ form.errors }}</pre>
              </div>
            {% endif %}

            {% if formset.errors %}
              <div class="alert alert-danger">
                <b>Kalem Hataları</b>
                <pre style="white-space: pre-wrap;">{{ formset.errors }}</pre>
              </div>
            {% endif %}

            <div class="row mb-3">
              <div class="col-md-4">
                <label class="form-label fw-bold">Tedarikçi</label>
                {{ form.tedarikci }}
                <div class="form-text">Sipariş tedarikçisi ile aynı olmak zorunda.</div>
              </div>
              <div class="col-md-4">
                <label class="form-label fw-bold">Fatura No</label>
                {{ form.fatura_no }}
              </div>
              <div class="col-md-4">
                <label class="form-label fw-bold">Fatura Tarihi</label>
                {{ form.tarih }}
              </div>
            </div>

            <div class="row mb-3">
              <div class="col-md-8">
                <label class="form-label fw-bold">Açıklama (Opsiyonel)</label>
                {{ form.aciklama }}
              </div>
              <div class="col-md-4">
                <label class="form-label fw-bold">Fatura Dosyası (Opsiyonel)</label>
                {{ form.dosya }}
              </div>
            </div>

            <hr class="my-4">

            <div class="d-flex justify-content-between align-items-center mb-2">
              <h6 class="fw-bold mb-0"><i class="fas fa-list me-2"></i>Fatura Kalemleri</h6>
              <div class="d-flex gap-2 align-items-center">
                <button type="button" class="btn btn-sm btn-outline-primary" id="add-row">
                  <i class="fas fa-plus me-1"></i> Satır Ekle
                </button>
                <small class="text-muted">Satır ekle butonuyla istediğin kadar kalem gir.</small>
              </div>
            </div>

            {{ formset.management_form }}

            {% if formset.non_form_errors %}
              <div class="alert alert-danger">{{ formset.non_form_errors }}</div>
            {% endif %}

            <div class="table-responsive">
              <table class="table table-bordered align-middle">
                <thead class="table-light">
                  <tr>
                    <th style="width:40%">Malzeme</th>
                    <th style="width:15%">Miktar</th>
                    <th style="width:20%">Birim Fiyat (KDV Hariç)</th>
                    <th style="width:10%">KDV</th>
                    <th style="width:10%">Sil</th>
                  </tr>
                </thead>
                <tbody id="kalemler-body">
                  {% for f in formset.forms %}
                    <tr class="kalem-row">
                      <td>
                        {{ f.malzeme }}
                        {% if f.malzeme.errors %}<div class="text-danger small">{{ f.malzeme.errors }}</div>{% endif %}
                      </td>
                      <td>
                        {{ f.miktar }}
                        {% if f.miktar.errors %}<div class="text-danger small">{{ f.miktar.errors }}</div>{% endif %}
                      </td>
                      <td>
                        {{ f.birim_fiyat }}
                        {% if f.birim_fiyat.errors %}<div class="text-danger small">{{ f.birim_fiyat.errors }}</div>{% endif %}
                      </td>
                      <td>
                        {{ f.kdv_orani }}
                        {% if f.kdv_orani.errors %}<div class="text-danger small">{{ f.kdv_orani.errors }}</div>{% endif %}
                      </td>
                      <td class="text-center">
                        {% if f.instance.pk %}
                          {{ f.DELETE }}
                        {% else %}
                          <button type="button" class="btn btn-sm btn-outline-danger remove-row" title="Satırı kaldır">
                            <i class="fas fa-times"></i>
                          </button>
                        {% endif %}
                      </td>
                    </tr>
                  {% endfor %}
                </tbody>
              </table>
            </div>

            <!-- EMPTY FORM TEMPLATE (JS ile çoğaltacağız) -->
            <template id="empty-form-template">
              <tr class="kalem-row">
                <td>__MALZEME__</td>
                <td>__MIKTAR__</td>
                <td>__BIRIM_FIYAT__</td>
                <td>__KDV__</td>
                <td class="text-center">
                  <button type="button" class="btn btn-sm btn-outline-danger remove-row" title="Satırı kaldır">
                    <i class="fas fa-times"></i>
                  </button>
                </td>
              </tr>
            </template>

            <div class="d-grid gap-2 mt-4">
              <button type="submit" class="btn btn-success btn-lg fw-bold">
                <i class="fas fa-save me-2"></i> FATURAYI KAYDET
              </button>
              <a href="{% url 'siparis_listesi' %}" class="btn btn-outline-secondary">İptal</a>
            </div>

          </form>

        </div>
      </div>
    </div>
  </div>
</div>

<script>
(function(){
  // Django default inline formset prefix: "form"
  const totalFormsInput = document.getElementById("id_form-TOTAL_FORMS");
  const body = document.getElementById("kalemler-body");
  const addBtn = document.getElementById("add-row");

  // Empty form html'ini Django'nun empty_form'undan güvenli üretelim:
  const emptyMalzeme = `{{ formset.empty_form.malzeme|escapejs }}`;
  const emptyMiktar = `{{ formset.empty_form.miktar|escapejs }}`;
  const emptyBirimFiyat = `{{ formset.empty_form.birim_fiyat|escapejs }}`;
  const emptyKdv = `{{ formset.empty_form.kdv_orani|escapejs }}`;

  function bindRemoveButtons(scope){
    (scope || document).querySelectorAll(".remove-row").forEach(btn => {
      if(btn.dataset.bound) return;
      btn.dataset.bound = "1";
      btn.addEventListener("click", function(){
        const tr = btn.closest("tr");
        if(tr) tr.remove();
        // IMPORTANT: TOTAL_FORMS'u düşürmüyoruz; Django index kaymasın.
        // Bunun yerine "silmek" gerekiyorsa DELETE kullanılır. Yeni satırda DELETE yok, kaldırmak yeterli.
      });
    });
  }

  addBtn.addEventListener("click", function(){
    const index = parseInt(totalFormsInput.value, 10);

    // empty_form içindeki "__prefix__" yerine index koy
    const malzemeHtml = emptyMalzeme.replaceAll("__prefix__", index);
    const miktarHtml = emptyMiktar.replaceAll("__prefix__", index);
    const birimHtml = emptyBirimFiyat.replaceAll("__prefix__", index);
    const kdvHtml = emptyKdv.replaceAll("__prefix__", index);

    const tpl = document.getElementById("empty-form-template").innerHTML
      .replace("__MALZEME__", malzemeHtml)
      .replace("__MIKTAR__", miktarHtml)
      .replace("__BIRIM_FIYAT__", birimHtml)
      .replace("__KDV__", kdvHtml);

    const temp = document.createElement("tbody");
    temp.innerHTML = tpl.trim();
    body.appendChild(temp.firstElementChild);

    totalFormsInput.value = index + 1;
    bindRemoveButtons(body);
  });

  bindRemoveButtons(body);
})();
</script>
{% endblock %}
