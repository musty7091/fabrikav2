{% extends 'base.html' %}
{% load humanize %}

{% block title %}Sipariş Takibi & Sevkiyat{% endblock %}

{% block content %}
<div class="container py-4">

    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h1 class="h3 mb-0 text-gray-800">
                <i class="fas fa-shipping-fast text-primary me-2"></i>SİPARİŞ TAKİBİ & SEVKİYAT
            </h1>
            <p class="text-muted small mb-0">Malzeme siparişlerini, fatura girişlerini ve sanal depodan sevkiyatları yönetin.</p>
        </div>
        <div class="btn-group">
            <a href="{% url 'icmal_raporu' %}" class="btn btn-outline-secondary">
                <i class="fas fa-table me-1"></i> İcmal'e Dön
            </a>
            <a href="{% url 'dashboard' %}" class="btn btn-secondary">
                <i class="fas fa-home me-1"></i> Ana Menü
            </a>
        </div>
    </div>

    <div class="card shadow mb-5 border-0 border-top border-warning border-3">
        <div class="card-header bg-warning bg-opacity-10 py-3 d-flex justify-content-between align-items-center">
            <h6 class="m-0 fw-bold text-dark">
                <i class="fas fa-clock me-2"></i>TESLİMAT / İLERLEME BEKLEYENLER (AKTİF)
            </h6>
            <span class="badge bg-warning text-dark">{{ bekleyenler|length }} Adet</span>
        </div>
        <div class="card-body p-0">
            <div class="table-responsive">
                <table class="table table-hover align-middle mb-0">
                    <thead class="bg-light text-dark">
                        <tr>
                            <th class="py-3 ps-3">TEDARİKÇİ FİRMA</th>
                            <th class="py-3">İŞ / MALZEME</th>
                            <th class="py-3 text-center">SİPARİŞ</th>
                            <th class="py-3 text-center">İLERLEME / STOK</th>
                            <th class="py-3 text-center">DURUM</th>
                            <th class="py-3 text-center">TAMAMLANMA</th>
                            <th class="py-3 text-end pe-3">İŞLEMLER</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for siparis in bekleyenler %}
                        <tr>
                            <td class="ps-3 fw-bold text-secondary">
                                {{ siparis.teklif.tedarikci.firma_unvani }}
                            </td>

                            <td>
                                {% if siparis.teklif.malzeme %}
                                    <div class="d-flex align-items-center">
                                        <div class="bg-light p-2 rounded me-2 text-primary">
                                            <i class="fas fa-box-open"></i>
                                        </div>
                                        <div>
                                            <span class="fw-bold d-block">{{ siparis.teklif.malzeme.isim }}</span>
                                            <small class="text-muted">{{ siparis.teklif.malzeme.marka|default:"-" }}</small>
                                        </div>
                                    </div>
                                {% else %}
                                    <div class="d-flex align-items-center">
                                        <div class="bg-light p-2 rounded me-2 text-info">
                                            <i class="fas fa-tools"></i>
                                        </div>
                                        <div>
                                            <span class="fw-bold d-block">{{ siparis.teklif.is_kalemi.isim }}</span>
                                            <small class="text-muted">Hizmet / İşçilik</small>
                                        </div>
                                    </div>
                                {% endif %}
                            </td>

                            <td class="text-center">
                                <span class="badge bg-light text-dark border">#{{ siparis.id }}</span>
                                <div class="small text-muted mt-1">{{ siparis.created_at|date:"d.m.Y" }}</div>
                            </td>

                            <td class="text-center">
                                <div class="fw-bold">{{ siparis.teslim_edilen|floatformat:0 }} / {{ siparis.toplam_miktar|floatformat:0 }}</div>
                                <small class="text-muted">
                                    {% if siparis.teklif.malzeme %}
                                        {{ siparis.teklif.malzeme.get_birim_display }}
                                    {% else %}
                                        {{ siparis.teklif.is_kalemi.get_birim_display }}
                                    {% endif %}
                                </small>
                            </td>

                            <td class="text-center">
                                {% if siparis.sanal_depoda_bekleyen > 0 %}
                                    <div class="d-flex flex-column align-items-center">
                                        <span class="badge bg-warning text-dark border border-dark shadow-sm mb-1">
                                            <i class="fas fa-dolly me-1"></i> Mal Kabul Bekliyor
                                        </span>
                                        <small class="text-danger fw-bold" style="font-size: 0.75rem;">
                                            ({{ siparis.sanal_depoda_bekleyen|floatformat:0 }} sanal depoda)
                                        </small>
                                    </div>
                                {% elif siparis.kalan_miktar > 0 %}
                                    <div class="d-flex flex-column align-items-center">
                                        <span class="badge bg-info text-dark border border-info mb-1">
                                            <i class="fas fa-truck me-1"></i> Sevkiyat Bekleniyor
                                        </span>
                                        <small class="text-muted" style="font-size: 0.75rem;">
                                            ({{ siparis.kalan_miktar|floatformat:0 }} eksik)
                                        </small>
                                    </div>
                                {% else %}
                                    <span class="badge bg-success">
                                        <i class="fas fa-check-circle"></i> Tamamlandı
                                    </span>
                                {% endif %}
                            </td>

                            <td class="text-center" style="width: 15%;">
                                <div class="progress" style="height: 6px;">
                                    <div class="progress-bar {% if siparis.yuzde_tamamlanma == 100 %}bg-success{% else %}bg-primary{% endif %}" 
                                         role="progressbar" 
                                         style="width: {{ siparis.yuzde_tamamlanma }}%">
                                    </div>
                                </div>
                                <small class="text-muted fw-bold mt-1 d-block">%{{ siparis.yuzde_tamamlanma|floatformat:0 }}</small>
                            </td>

                            <td class="text-end pe-3">
                                <div class="btn-group">
                                    {% if siparis.teklif.malzeme %}
                                        {% if siparis.sanal_depoda_bekleyen > 0 %}
                                            <a href="{% url 'mal_kabul' siparis.id %}" class="btn btn-sm btn-warning fw-bold text-dark" title="Sanal depodan asıl depoya al">
                                                <i class="fas fa-dolly"></i> Mal Kabul
                                            </a>
                                        {% endif %}
                                        
                                        {% if siparis.kalan_miktar > 0 %}
                                            <a href="{% url 'fatura_girisi' siparis.id %}" class="btn btn-sm btn-primary" title="Fatura ve İrsaliye İşle">
                                                <i class="fas fa-file-invoice"></i> Fatura Gir
                                            </a>
                                        {% endif %}
                                    {% else %}
                                        <a href="{% url 'hakedis_ekle' siparis.id %}" class="btn btn-sm btn-success text-white">
                                            <i class="fas fa-hard-hat"></i> Hakediş
                                        </a>
                                    {% endif %}
                                    
                                    <a href="{% url 'siparis_detay' siparis.id %}" class="btn btn-sm btn-light border" title="Detay">
                                        <i class="fas fa-eye"></i>
                                    </a>
                                </div>
                            </td>
                        </tr>
                        {% empty %}
                        <tr>
                            <td colspan="7" class="text-center py-5 text-muted">
                                <i class="fas fa-check-circle fa-3x mb-3 text-success"></i>
                                <p class="mb-0 fw-bold">Bekleyen veya sevkiyatı süren sipariş yok.</p>
                                <small>Tüm siparişler tamamlanmış görünüyor.</small>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <div class="card shadow border-0 border-top border-success border-3">
        <div class="card-header bg-success bg-opacity-10 py-3">
            <h6 class="m-0 fw-bold text-success">
                <i class="fas fa-history me-2"></i>TAMAMLANAN SİPARİŞ GEÇMİŞİ (TESLİM ALINANLAR)
            </h6>
        </div>
        <div class="card-body p-0">
            <div class="table-responsive">
                <table class="table table-hover align-middle mb-0" id="tamamlanan-siparisler-tablosu">
                    <thead class="bg-light">
                        <tr>
                            <th class="py-3 ps-3">TEDARİKÇİ</th>
                            <th class="py-3">MALZEME / İŞ</th>
                            <th class="py-3 text-center">TARİH</th>
                            <th class="py-3 text-center">MİKTAR</th>
                            <th class="py-3 text-center">DURUM</th>
                            <th class="py-3 text-end pe-3">İŞLEMLER</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for siparis in bitenler %}
                        <tr>
                            <td class="ps-3 text-muted">{{ siparis.teklif.tedarikci.firma_unvani }}</td>
                            <td>
                                {% if siparis.teklif.malzeme %}
                                    <i class="fas fa-box text-secondary me-2"></i>{{ siparis.teklif.malzeme.isim }}
                                {% else %}
                                    <i class="fas fa-tools text-secondary me-2"></i>{{ siparis.teklif.is_kalemi.isim }}
                                {% endif %}
                            </td>
                            <td class="text-center small text-muted">{{ siparis.created_at|date:"d.m.Y" }}</td>
                            
                            <td class="text-center fw-bold text-dark">
                                {{ siparis.teslim_edilen|floatformat:0 }} 
                                <small class="text-muted fw-normal">
                                    {% if siparis.teklif.malzeme %}
                                        {{ siparis.teklif.malzeme.get_birim_display }}
                                    {% else %}
                                        {{ siparis.teklif.is_kalemi.get_birim_display }}
                                    {% endif %}
                                </small>
                            </td>

                            <td class="text-center">
                                <span class="badge bg-success">
                                    <i class="fas fa-check-double me-1"></i> Bağlantıya aktarıldı
                                </span>
                            </td>

                            <td class="text-end pe-3">
                                <div class="btn-group">
                                    <a href="{% url 'siparis_detay' siparis.id %}" class="btn btn-sm btn-outline-secondary" title="Geçmişi Gör">
                                        <i class="fas fa-history"></i>
                                    </a>
                                    <a href="#" class="btn btn-sm btn-outline-secondary" title="Yazdır">
                                        <i class="fas fa-print"></i>
                                    </a>
                                </div>
                            </td>
                        </tr>
                        {% empty %}
                        <tr>
                            <td colspan="6" class="text-center py-4 text-muted small">
                                Henüz tamamlanmış (arşive kalkmış) bir sipariş bulunmuyor.
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>

</div>
{% endblock %}